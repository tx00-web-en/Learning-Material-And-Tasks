# Pair Programming Part 2: 

In this pair, you'll be adding authentication to last week's API and protecting the CRUD operations (create, read, update, delete) for tours. 

We will work through this step by step. However, there will **not** be a detailed explanation for each step—it's up to you and your partner to apply your knowledge and problem-solve together. 

If a step is unclear, feel free to ask for help. If the same question arises frequently, I may call all groups to the main room for clarification.

---

### **Iteration 1: Set Up**

1. Clone the starter repository: [Week 6 Starter Code](https://github.com/tx00-resources-en/week6-bepp-starter)
   - After cloning, **delete** the `.git` directory.
2. Rename `.env.example` to `.env`.
3. Run `npm install`
4. Run the following tests in your terminal to ensure everything is set up correctly. There should be no errors:
   ```
   npm test users.test.js
   npm test todoTasks.test.js
   ```

---

### **Iteration 2: Securing Tour Routes**

1. Add this path to the toursModel:
   ```js
      user_id: {
         type: mongoose.Schema.Types.ObjectId,
         required: true,
         ref: "User",
      },
   ```

   > **Note:** The `user_id` field is automatically generated by the `requireAuth` middleware when you send the token. You do not need to manually provide this field in the client (e.g., Postman).  

2. Start the server by running:
   ```
   npm run dev
   ```

3. Use Postman to test **all tour-related endpoints** (GET, POST, PUT, DELETE). Ensure they're functional. You need to **Set the Authorization Header in Postman:**  
   - Navigate to the *Authorization* tab.  
   - Select **Bearer Token** from the **Auth Type** dropdown.  
   - Paste your token into the token field.  

4. Protect the tour routes by adding the following lines to `tourRouter.js`:
   ```javascript
   const requireAuth = require("../middleware/requireAuth");
   router.use(requireAuth);
   ```

5. Test the `GET /api/tours` endpoint in Postman. You should receive an "Unauthorized" error.

6. Modify the `getAllTours` controller so that it works with authentication. You can refer to the `getTodoTasks()` method in `todoTaskController.js`. Pay attention to these two lines:
   ```javascript
   const user_id = req.user._id;
   const todoTasks = await TodoTask.find({ user_id });
   ```

7. Test the `GET /api/tours` endpoint again in Postman—it should work now.

8. **Repeat** `steps 5-6` for **`all other tour-related endpoints (POST, DELETE, etc.).`**


---

### **Iteration 3: Understanding Authentication Logic**

1. In the `middleware/requireAuth.js` file, you'll find the logic that protects routes. 
   - Uncomment **lines 1-15**.
   - Add your own console logs to understand the logic.
2. Answer the following question:
   - What does this line of code do?
     ```javascript
     req.user = await User.findOne({ _id }).select("_id");
     ```

---

### **Iteration 4: Expanding the User Model**

1. Modify the `userModel.js` to include additional fields, so that it looks like this:
   ```javascript
   {
     name: { type: String, required: true },
     email: { type: String, required: true, unique: true },
     password: { type: String, required: true },
     phone_number: { type: String, required: true },
     gender: { type: String, required: true },
     date_of_birth: { type: Date, required: true },
     membership_status: { type: String, required: true },
   }
   ```
2. Update the methods in the model:
   - `userSchema.statics.signup()`
   - `userSchema.statics.login()`
   
3. Discuss and document:
   - What are these functions (`userSchema.statics.signup()` and `userSchema.statics.login()`)?
   - Why are they used?
   - What are the pros and cons of using this approach?
   - What alternative approaches are available?


4. **Test Signup and Login Functionality:**  
   - Test the signup and login functionality with the new user fields. Please:
   - Use strong passwords. For example: `R3g5T7#gh`.  
   - Ensure the date of birth is in the correct format: `"YYYY-MM-DD"` (e.g., `"1999-01-01"`).  
   - Here’s an example of a complete request body for registering a new user:  
   ```json
   {
      "name": "Pekka",
      "email": "pekka13@pekka.com",
      "password": "R3g5T7#gh",
      "phone_number": "1234567890",
      "gender": "Male",
      "date_of_birth": "1999-01-01",
      "membership_status": "Active"
   }
   ```
5. Commit your changes.

---

### **Iteration 5: Final Testing**

1. Test all the tour-related endpoints to ensure they are still functional after the modifications.
   ```
   npm test tours.test.js
   ```
2. Reflect:
   - Did you need to make any changes to the tour-related functions? Why or why not?

3. Push your changes to the repository.

---
**Happy coding!** :rocket: :heart: 